<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WiFi Central Victoria - Portal de Acceso</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
      }

      .container {
        max-width: 450px;
        width: 90%;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        padding: 40px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
      }

      .version-badge {
        background: linear-gradient(45deg, #ff6b6b, #feca57);
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        margin-bottom: 20px;
        display: inline-block;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .logo {
        font-size: 4rem;
        margin-bottom: 20px;
        animation: bounce 2s infinite;
      }

      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-10px);
        }
        60% {
          transform: translateY(-5px);
        }
      }

      h1 {
        font-size: 2.2rem;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 30px;
      }

      .no-cash-banner {
        background: linear-gradient(45deg, #ff4757, #ff3838);
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 25px;
        border: 2px solid #ff6b6b;
      }

      .no-cash-banner h3 {
        font-size: 1.3rem;
        margin-bottom: 8px;
      }

      .payment-methods {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 25px 0;
      }

      .payment-option {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .payment-option:hover {
        transform: translateY(-5px);
        border-color: #48dbfb;
        box-shadow: 0 15px 30px rgba(72, 219, 251, 0.3);
      }

      .payment-option.selected {
        border-color: #48dbfb;
        background: rgba(72, 219, 251, 0.2);
      }

      .payment-option.free-plan {
        border-color: #2ed573;
        background: rgba(46, 213, 115, 0.1);
      }

      .payment-option.free-plan .payment-price {
        color: #2ed573;
        font-size: 1.2rem;
      }

      .payment-option.premium {
        border-color: #feca57;
        background: rgba(254, 202, 87, 0.1);
      }

      .payment-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .payment-name {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .payment-price {
        font-size: 1.5rem;
        color: #feca57;
        font-weight: bold;
      }

      .user-form {
        margin: 25px 0;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #feca57;
      }

      .form-group input {
        width: 100%;
        padding: 15px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-group input:focus {
        outline: none;
        border-color: #48dbfb;
        box-shadow: 0 0 20px rgba(72, 219, 251, 0.3);
      }

      .form-group input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .pay-button {
        width: 100%;
        padding: 18px;
        background: linear-gradient(45deg, #48dbfb, #0abde3);
        border: none;
        border-radius: 15px;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
      }

      .external-box {
        background: rgba(255, 255, 255, 0.12);
        border: 1px dashed rgba(255, 255, 255, 0.35);
        border-radius: 12px;
        padding: 12px;
      }
      .open-external {
        display: inline-block;
        margin-top: 8px;
        padding: 10px 14px;
        border-radius: 10px;
        background: rgba(72, 219, 251, 0.2);
        border: 1px solid #48dbfb;
        color: #fff;
        text-decoration: none;
        font-weight: 600;
      }
      .open-external:hover {
        filter: brightness(1.1);
      }
      .mini-note {
        opacity: 0.85;
        font-size: 0.9rem;
        margin-top: 6px;
      }

      .pay-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(72, 219, 251, 0.4);
      }

      .pay-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .qr-container {
        display: none;
        margin: 25px 0;
        padding: 25px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        color: #333;
      }

      .qr-code {
        width: 200px;
        height: 200px;
        background: white;
        margin: 20px auto;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        border: 3px solid #48dbfb;
      }

      .timer {
        font-size: 1.5rem;
        color: #ff4757;
        font-weight: bold;
        margin-top: 15px;
      }

      .success-message {
        display: none;
        background: linear-gradient(45deg, #2ed573, #1e90ff);
        padding: 25px;
        border-radius: 15px;
        margin: 20px 0;
      }

      .success-message h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }

      .wifi-credentials {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin-top: 15px;
      }

      .wifi-credentials strong {
        color: #feca57;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top: 5px solid #48dbfb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .digital-wallets {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin: 20px 0;
      }

      .wallet-option {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        padding: 15px 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }

      .wallet-option:hover {
        border-color: #48dbfb;
        transform: scale(1.05);
      }

      .wallet-option.selected {
        border-color: #48dbfb;
        background: rgba(72, 219, 251, 0.2);
      }

      .wallet-icon {
        font-size: 1.5rem;
        margin-bottom: 5px;
      }

      .wallet-name {
        font-size: 0.8rem;
        font-weight: bold;
      }

      .security-badges {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .security-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      @media (max-width: 480px) {
        .container {
          padding: 25px;
          margin: 20px;
        }

        .payment-methods {
          grid-template-columns: 1fr;
        }

        .digital-wallets {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo">🚌</div>
      <h1>TravelLineOK WiFi</h1>
      <p class="subtitle">Conectate con pagos 100% digitales</p>

      <div class="no-cash-banner">
        <h3>🚫 SIN EFECTIVO</h3>
        <p>Solo Mercado Pago</p>
      </div>

      <!-- Formulario de Usuario -->
      <div class="user-form" id="userForm">
        <div class="form-group">
          <label for="userName">👤 Nombre completo</label>
          <input
            type="text"
            id="userName"
            placeholder="Ingresa tu nombre"
            required
          />
        </div>

        <div class="form-group">
          <label for="userEmail">📧 Email</label>
          <input
            type="email"
            id="userEmail"
            placeholder="tu@email.com"
            required
          />
        </div>

        <div class="form-group">
          <label for="userPhone">📱 Teléfono</label>
          <input
            type="tel"
            id="userPhone"
            placeholder="+54 9 11 1234-5678"
            required
          />
        </div>
      </div>

      <!-- Opciones de Pago -->
      <div class="payment-methods">
        <div
          class="payment-option premium"
          data-plan="1hora"
          onclick="selectPlan('1hora', 500)"
        >
          <div class="payment-icon">⏳</div>
          <div class="payment-name">1 Hora</div>
          <div class="payment-price">$500</div>
        </div>

        <div
          class="payment-option"
          data-plan="12horas"
          onclick="selectPlan('12horas', 5000)"
        >
          <div class="payment-icon">🕐</div>
          <div class="payment-name">12 Horas</div>
          <div class="payment-price">$5.000</div>
        </div>

        <div
          class="payment-option"
          data-plan="24horas"
          onclick="selectPlan('24horas', 8000)"
        >
          <div class="payment-icon">🌅</div>
          <div class="payment-name">24 Horas</div>
          <div class="payment-price">$8.000</div>
        </div>
        <!--
        <div
          class="payment-option"
          data-plan="tiempo"
          onclick="showTimeRemaining()"
        >
          <div class="payment-icon">⏰</div>
          <div class="payment-name">Tiempo Restante</div>
          <div class="payment-price" id="timeRemaining">--:--:--</div>
        </div>
        -->
      </div>

      <!--
         Billeteras Digitales --
        <div class="digital-wallets">
            <div class="wallet-option" data-wallet="mercadopago" onclick="selectWallet('mercadopago')">
                <div class="wallet-icon">💙</div>
                <div class="wallet-name">MercadoPago</div>
            </div>

            
            
            Comentado hasta tener las demas billeteras
            ----------------------------------------------------------
            <div class="wallet-option" data-wallet="uala" onclick="selectWallet('uala')">
                <div class="wallet-icon">🔵</div>
                <div class="wallet-name">Ualá</div>
            </div>
            
            <div class="wallet-option" data-wallet="brubank" onclick="selectWallet('brubank')">
                <div class="wallet-icon">🟣</div>
                <div class="wallet-name">Brubank</div>
            </div>
            
            <div class="wallet-option" data-wallet="tarjeta" onclick="selectWallet('tarjeta')">
                <div class="wallet-icon">💳</div>
                <div class="wallet-name">Tarjeta</div>
            </div>
        </div> -->

      <!-- Badges de Seguridad 
      <div class="security-badges">
        <div class="security-badge">🔒 SSL Seguro</div>
        <div class="security-badge">🛡️ 3D Secure</div>
        <div class="security-badge">⚡ Instantáneo</div>
      </div>
      -->
      <button class="pay-button" onclick="processPayment()" id="payButton">
        💳 Selecciona un plan para continuar
      </button>

      <!-- Fallback externo (oculto por defecto) 
      <div id="externalHint" style="display: none; margin-top: 12px">
        <div class="external-box">
          <p><strong>¿No se abrió Mercado Pago?</strong></p>
          <a
            id="fallbackLink"
            class="open-external"
            href="#"
            target="_blank"
            rel="noopener"
          >
            🔗 Abrir pago en el navegador (recomendado)
          </a>
          <div class="mini-note">
            Si el navegador interno bloquea ventanas, usá este botón. No te
            habilita internet hasta que el pago quede aprobado.
          </div>

          (opcional) Mostrar el link para copiar 
          <div
            id="rawLinkBox"
            style="display: none; word-break: break-all; margin-top: 8px"
          >
            <small
              >O copiá y pegá este enlace: <span id="rawLink"></span
            ></small>
          </div>
        </div>
      </div>

      <button
        id="openExternalBtn"
        class="pay-button"
        style="
          display: none;
          margin-top: 10px;
          background: linear-gradient(45deg, #10ac84, #1dd1a1);
        "
      >
        🌐 Abrir en navegador (si no se abre solo)
      </button>
      -->
      <div id="externalHint" style="display: none; margin-top: 12px">
        <div class="external-box">
          <p style="font-weight: 700; margin-bottom: 6px">
            📋 Copie y pegue el siguiente enlace en su navegador para abrir
            Mercado Pago
          </p>

          <div
            id="rawLinkBox"
            style="display: none; word-break: break-all; margin-top: 10px"
          >
            <div
              id="rawLink"
              style="
                font-size: 1.15rem;
                line-height: 1.4;
                padding: 12px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 10px;
                border: 1px dashed rgba(255, 255, 255, 0.35);
              "
            ></div>
          </div>

          <!-- ÚNICO botón, con el mismo estilo que "Pagar con MercadoPago" -->
          <button id="copyLinkBtn" class="pay-button" style="margin-top: 12px">
            📋 Copiar enlace
          </button>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Procesando pago seguro...</p>
      </div>

      <!-- QR Container 
      <div class="qr-container" id="qrContainer">
        <h3>📱 Escanea el código QR</h3>
        <div class="qr-code" id="qrCode">📱</div>
        <p>Código dinámico - Se actualiza cada 30 segundos</p>
        <div class="timer" id="timer">30</div>
      </div>
      -->

      <!-- Success Message -->
      <div class="success-message" id="successMessage">
        <h3>Su solicitud se ha generado con exito!</h3>
        <p>
          Aguarde un minuto, si no se conecta automáticamente pruebe apagando y
          volviendo a prender su Wi-Fi
        </p>
        <!--
        <div class="wifi-credentials">
          <p><strong>Red:</strong> WiFi_Central_Victoria</p>
          <p>
            <strong>Contraseña:</strong>
            <span id="wifiPassword">Premium2024!</span>
          </p>
          <p><strong>Velocidad:</strong> <span id="wifiSpeed">50 Mbps</span></p>
        </div>
        -->
      </div>
    </div>

    <script>
      // --- CONFIG (dejar esto arriba del todo) ---
      const API_BASE = "https://travellineok.com"; // único lugar

      const urlParams = new URLSearchParams(location.search);
      const MAC_FROM_URL = (
        urlParams.get("mac") || "AA:BB:CC:DD:EE:FF"
      ).toUpperCase();
      const BUS_ID_FROM_URL = urlParams.get("bus_id") || "BUS-001";
      const ORDER_ID_FROM_URL = urlParams.get("order_id");
      const FAILED_FLAG = urlParams.get("failed");
      // Variables globales
      let selectedPlan = null;
      let selectedWallet = null;
      let selectedPrice = 0;
      let paymentTimer = null;
      let qrTimer = null;
      let qrCountdown = 30;

      // --- Helpers de navegador externo / webview ---
      function isWebView() {
        const ua = navigator.userAgent || "";
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);

        // Android webview suele traer "; wv)" y no el Chrome completo
        const isAndroidWV = isAndroid && /\; wv\)/i.test(ua);

        // iOS webview: Safari real trae "Safari"; los webviews típicos NO.
        const isIOSWV = isIOS && !/Safari/i.test(ua);

        return isAndroidWV || isIOSWV;
      }

      // Si el usuario vuelve desde el navegador externo, seguimos chequeando la orden
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          // al volver al portal, no hacemos nada especial; el poll ya corre si estaba iniciado
        }
      });

      // Abre SIEMPRE fuera del webview (Chrome/Safari). Sin redirecciones auto.
      function openExternal(url) {
        if (!url) return;
        const ua = navigator.userAgent || "";
        const isAndroid = /Android/i.test(ua);

        if (isAndroid) {
          // Intent a Chrome (salta del webview) + fallback al link nativo
          const stripped = url.replace(/^https?:\/\//, "");
          const intent = `intent://${stripped}#Intent;scheme=https;package=com.android.chrome;end`;
          location.href = intent;
          setTimeout(() => {
            try {
              window.open(url, "_blank", "noopener,noreferrer");
            } catch (e) {}
          }, 600);
          return;
        }

        // iOS / otros: primer intento en misma vista (iOS suele ofrecer 'Abrir en Safari')
        try {
          window.location.href = url;
        } catch (e) {}
        // 2ª chance: link visible si el webview bloquea
        setTimeout(() => {
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = "Abrir Mercado Pago";
          a.style =
            "display:block;margin:16px 0;text-align:center;font:16px sans-serif;";
          document.body.appendChild(a);
        }, 400);
      }

      function openExternalAndPoll(e) {
        if (e) e.preventDefault();
        if (!window.__lastInitPoint || !window.__lastOrderId) {
          alert("Primero tocá ‘Pagar’ para generar la orden.");
          return;
        }
        openExternal(window.__lastInitPoint);
        startPaidPolling(); // Arrancamos el polling en el portal actual
      }

      async function startPaidPolling() {
        const id = window.__lastOrderId;
        if (!id) return;

        const loading = document.getElementById("loading");
        if (loading) loading.style.display = "block";

        const res = await pollOrder(id, { intervalMs: 3000, maxMs: 180000 });

        if (loading) loading.style.display = "none"; // ✅ volver a ocultar

        if (res?.ok) {
          const planUi = mapPlanFromBackend(res.data.plan);
          showResultApproved(planUi);
        } else if (res?.timeout) {
          alert(
            "Aún no recibimos confirmación del pago. Volvé desde MP y actualizá esta página."
          );
        } else {
          alert("El pago fue rechazado o cancelado. Probá nuevamente.");
        }
      }

      // Para el botón de respaldo
      function manualExternalOpen() {
        if (window.__lastInitPoint) openExternal(window.__lastInitPoint);
      }

      async function waitForInternet({ tries = 60, intervalMs = 1000 } = {}) {
        for (let i = 0; i < tries; i++) {
          try {
            await fetch("https://travellineok.com/health", {
              cache: "no-store",
              mode: "no-cors",
            });
            // Si llega hasta acá, ya no hubo bloqueo de red.
            document.getElementById("loading").style.display = "none";
            document.getElementById("successMessage").style.display = "block";
            return true;
          } catch (e) {}
          await new Promise((r) => setTimeout(r, intervalMs));
        }
        return false;
      }

      // Polling del estado de la orden
      async function pollOrder(
        orderId,
        { intervalMs = 2000, maxMs = 120000 } = {}
      ) {
        const t0 = Date.now();
        while (Date.now() - t0 < maxMs) {
          try {
            const r = await fetch(`${API_BASE}/orders/${orderId}`);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const data = await r.json(); // {status, plan, ...}

            if (data.status === "approved") return { ok: true, data };
            if (data.status === "rejected") return { ok: false, data };

            // pending aún: esperamos y seguimos
            await new Promise((res) => setTimeout(res, intervalMs));
          } catch (e) {
            // falló la consulta, reintenta suave
            await new Promise((res) => setTimeout(res, intervalMs));
          }
        }
        // Timeout
        return { timeout: true };
      }

      // Muestra el resultado en tu misma UI
      function showResultApproved(planUi) {
        // reutiliza tu successMessage:
        document.getElementById("loading").style.display = "none";
        document.getElementById("successMessage").style.display = "block";

        /*
        const wifiConfigs = {
          "1hora": { password: "Free1H_2024!", speed: "5 Mbps" },
          "12horas": { password: "Wifi12H_2024!", speed: "25 Mbps" },
          "24horas": { password: "Wifi24H_2024!", speed: "35 Mbps" },
        };
        const cfg = wifiConfigs[planUi] || wifiConfigs["12horas"];
        document.getElementById("wifiPassword").textContent = cfg.password;
        document.getElementById("wifiSpeed").textContent = cfg.speed;
        */
      }

      function showResultRejected() {
        document.getElementById("loading").style.display = "none";
        alert("El pago no se aprobó. Por favor, intentá nuevamente.");
      }

      // Mapear plan backend -> etiqueta UI (para mostrar credenciales/velocidad)
      function mapPlanFromBackend(plan) {
        if (plan === "PAID_1H") return "1hora";
        if (plan === "PAID_12H") return "12horas";
        if (plan === "PAID_24H") return "24horas";
        return "12horas";
      }

      // Si volvimos desde MP con order_id: arrancamos el flow de resultado
      (async function handleReturnFromMP() {
        if (!ORDER_ID_FROM_URL) return;

        // Mostrar “cargando” mientras consultamos
        const loading = document.getElementById("loading");
        const payBtn = document.getElementById("payButton");
        if (loading) loading.style.display = "block";
        if (payBtn) payBtn.disabled = true;

        // Opcional: si MP nos marcó failed=1, lo indicamos (igual chequeamos backend)
        if (FAILED_FLAG) {
          console.log("MP back_url venía con failed=1");
        }

        const res = await pollOrder(ORDER_ID_FROM_URL);
        if (res?.ok) {
          const planUi = mapPlanFromBackend(res.data.plan);
          showResultApproved(planUi);
        } else if (res?.timeout) {
          // Si tardó mucho, el usuario puede reintentar; el webhook suele resolver igual
          alert(
            "Aún no recibimos confirmación del pago. Actualizá la página en unos segundos."
          );
          if (loading) loading.style.display = "none";
          if (payBtn) payBtn.disabled = false;
        } else {
          showResultRejected();
          if (payBtn) payBtn.disabled = false;
        }
      })();

      function getQueryParam(name) {
        return urlParams.get(name);
      }

      const mac = (urlParams.get("mac") || "AA:BB:CC:DD:EE:FF").toUpperCase();
      const busId = urlParams.get("bus_id") || "BUS-001";

      // --- Mapeo nombres del front -> planes del backend ---
      function mapPlanToBackend(plan) {
        if (plan === "1hora") return "PAID_1H";
        if (plan === "12horas") return "PAID_12H";
        if (plan === "24horas") return "PAID_24H";
        return null;
      }

      // Seleccionar plan
      function selectPlan(plan, price) {
        // Remover selección anterior
        document.querySelectorAll(".payment-option").forEach((option) => {
          option.classList.remove("selected");
        });

        // Marcar el plan seleccionado
        document
          .querySelector(`[data-plan="${plan}"]`)
          .classList.add("selected");

        // Guardar selección global
        selectedPlan = plan;
        selectedPrice = price;

        // Ocultar cosas que ya no usamos (wallets, badges extra)
        const walletsContainer = document.querySelector(".digital-wallets");
        const securityBadges = document.querySelector(".security-badges");

        if (walletsContainer) walletsContainer.style.display = "none";
        if (securityBadges) securityBadges.style.display = "none";

        // Actualizar el estado del botón según el plan
        updatePayButton();
      }

      /*
          // Seleccionar billetera
          function selectWallet(wallet) {
            // Remover selección anterior
            document.querySelectorAll(".wallet-option").forEach((option) => {
              option.classList.remove("selected");
            });

            // Seleccionar nueva billetera
            document
              .querySelector(`[data-wallet="${wallet}"]`)
              .classList.add("selected");
            selectedWallet = wallet;

            updatePayButton();
          }
          */

      // Mapea los nombres visibles del UI a lo que espera tu backend
      function mapPlanToApi(planUi) {
        if (planUi === "1hora") return "PAID_1H";
        if (planUi === "12horas") return "PAID_12H";
        if (planUi === "24horas") return "PAID_24H";
        throw new Error("Plan inválido");
      }

      // Actualizar botón de pago
      function updatePayButton() {
        const payButton = document.getElementById("payButton");
        const userName = document.getElementById("userName").value.trim();
        const userEmail = document.getElementById("userEmail").value.trim();
        const userPhone = document.getElementById("userPhone").value.trim();

        if (!selectedPlan) {
          payButton.disabled = true;
          payButton.textContent = "💳 Selecciona un plan para continuar";
          return;
        }

        if (!userName || !userEmail || !userPhone) {
          payButton.disabled = true;
          payButton.textContent = "💳 Completa tus datos";
          return;
        }
        payButton.disabled = false;
        payButton.textContent = `💳 Pagar $${selectedPrice.toLocaleString()} con MercadoPago`;
      }

      /*
          // Obtener nombre de billetera
          function getWalletName(wallet) {
            const names = {
              mercadopago: "MercadoPago",
              uala: "Ualá",
              brubank: "Brubank",
              tarjeta: "Tarjeta",
            };
            return names[wallet] || "Método Digital";
          }
          */

      // Procesar pago (sin redirección automática)
      async function processPayment() {
        const userName = document.getElementById("userName").value.trim();
        const userEmail = document.getElementById("userEmail").value.trim();
        const userPhone = document.getElementById("userPhone").value.trim();

        if (!selectedPlan) {
          alert("Selecciona un plan.");
          return;
        }
        if (!userName || !userEmail || !userPhone) {
          alert("Completá nombre, email y teléfono.");
          return;
        }

        const planApi = mapPlanToApi(selectedPlan);

        const loading = document.getElementById("loading");
        const payBtn = document.getElementById("payButton");
        if (loading) loading.style.display = "block";
        if (payBtn) payBtn.disabled = true;

        try {
          const resp = await fetch(`${API_BASE}/orders`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              plan: planApi,
              mac: MAC_FROM_URL,
              bus_id: BUS_ID_FROM_URL,
            }),
          });
          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error(`Error backend (${resp.status}): ${txt}`);
          }

          const data = await resp.json(); // { order_id, status, init_point }

          // PAGOS: NO redirigimos. Mostramos panel con link/botón externo.
          const initPoint = data.init_point;
          if (!initPoint)
            throw new Error("No llegó init_point desde el backend.");

          window.__lastInitPoint = initPoint;
          window.__lastOrderId = data.order_id;
          console.log("[MP init_point]", initPoint);

          // Mostrar panel y link grande para copiar
          const hint = document.getElementById("externalHint");
          const rawBox = document.getElementById("rawLinkBox");
          const raw = document.getElementById("rawLink");
          if (hint) hint.style.display = "block";
          if (raw && rawBox) {
            raw.textContent = initPoint; // visible y copiable
            rawBox.style.display = "block";
          }

          // Botón: abrir externo + empezar a evaluar el estado (poll)
          const openBtn = document.getElementById("openExternalBtn");
          if (openBtn) {
            openBtn.onclick = function (e) {
              e.preventDefault();
              if (typeof openExternalAndPoll === "function") {
                openExternalAndPoll(e);
              } else {
                openExternal(window.__lastInitPoint);
                startPaidPolling();
              }
            };
          }

          // Botón: copiar enlace
          const copyBtn = document.getElementById("copyLinkBtn");
          if (copyBtn) {
            copyBtn.onclick = async () => {
              try {
                await navigator.clipboard.writeText(initPoint);
                copyBtn.textContent = "✅ Copiado";
                setTimeout(
                  () => (copyBtn.textContent = "📋 Copiar enlace"),
                  1500
                );
              } catch (err) {
                // Fallback
                const ta = document.createElement("textarea");
                ta.value = initPoint;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand("copy");
                document.body.removeChild(ta);
                copyBtn.textContent = "✅ Copiado";
                setTimeout(
                  () => (copyBtn.textContent = "📋 Copiar enlace"),
                  1500
                );
              }
            };
          } // <-- ESTE era el } que faltaba

          // Ya fuera del if(copyBtn)
          if (loading) loading.style.display = "none";
          if (payBtn) payBtn.disabled = false;
        } catch (err) {
          console.error(err);
          alert("No se pudo iniciar el proceso. " + (err?.message || err));
          if (loading) loading.style.display = "none";
          if (payBtn) payBtn.disabled = false;
        }
      }

      // Generar código QR dinámico
      function generateQRCode() {
        const codes = ["📱💙", "💳🔵", "📲💜", "💰🟢", "🔒💛"];
        return codes[Math.floor(Math.random() * codes.length)];
      }

      // Mostrar formulario de tarjeta
      function showCardForm(preference) {
        // Para este demo, simulamos pago exitoso
        setTimeout(() => {
          completePayment();
        }, 3000);
      }

      // Actualizar código QR
      function updateQRCode() {
        const qrCode = document.getElementById("qrCode");
        qrCode.textContent = generateQRCode();
      }

      // Iniciar timer de QR
      function startQRTimer() {
        qrCountdown = 30;
        qrTimer = setInterval(() => {
          qrCountdown--;
          document.getElementById("timer").textContent = qrCountdown;

          if (qrCountdown <= 0) {
            updateQRCode();
            qrCountdown = 30;
          }
        }, 1000);
      }

      // Completar pago
      function completePayment() {
        // Limpiar timers
        if (qrTimer) clearInterval(qrTimer);

        // Ocultar elementos de pago
        document.getElementById("loading").style.display = "none";
        document.getElementById("qrContainer").style.display = "none";

        // Mostrar mensaje de éxito
        document.getElementById("successMessage").style.display = "block";

        // Configurar credenciales WiFi según el plan
        const wifiConfigs = {
          "1hora": { password: "Free1H_2024!", speed: "5 Mbps" },
          "12horas": { password: "Wifi12H_2024!", speed: "25 Mbps" },
          "24horas": { password: "Wifi24H_2024!", speed: "35 Mbps" },
        };

        const config = wifiConfigs[selectedPlan];
        //document.getElementById("wifiPassword").textContent = config.password;
        //document.getElementById("wifiSpeed").textContent = config.speed;

        // Guardar tiempo de conexión según el plan
        const planTimes = {
          "1hora": 3600, // 1 hora en segundos
          "12horas": 43200, // 12 horas en segundos
          "24horas": 86400, // 24 horas en segundos
        };

        if (planTimes[selectedPlan]) {
          localStorage.setItem(
            "wifiTimeRemaining",
            planTimes[selectedPlan].toString()
          );
          localStorage.setItem("currentSpeed", config.speed);
        }

        // Simular conexión automática después de 3 segundos
        setTimeout(() => {
          // Aquí se conectaría automáticamente al WiFi
          alert(
            "🎉 ¡Conectado automáticamente al WiFi!\n\nYa puedes navegar sin límites."
          );
        }, 3000);
      }

      // Event listeners para formulario
      document
        .getElementById("userName")
        .addEventListener("input", updatePayButton);
      document
        .getElementById("userEmail")
        .addEventListener("input", updatePayButton);
      document
        .getElementById("userPhone")
        .addEventListener("input", updatePayButton);

      // Formatear teléfono automáticamente
      document
        .getElementById("userPhone")
        .addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 0) {
            if (value.length <= 2) {
              value = `+${value}`;
            } else if (value.length <= 4) {
              value = `+${value.slice(0, 2)} ${value.slice(2)}`;
            } else if (value.length <= 6) {
              value = `+${value.slice(0, 2)} ${value.slice(2, 4)} ${value.slice(
                4
              )}`;
            } else {
              value = `+${value.slice(0, 2)} ${value.slice(2, 4)} ${value.slice(
                4,
                6
              )} ${value.slice(6, 10)}-${value.slice(10, 14)}`;
            }
          }
          e.target.value = value;
        });

      // Validar email en tiempo real
      document
        .getElementById("userEmail")
        .addEventListener("blur", function (e) {
          const email = e.target.value;
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (email && !emailRegex.test(email)) {
            e.target.style.borderColor = "#ff4757";
            alert("Por favor ingresa un email válido");
          } else {
            e.target.style.borderColor = "rgba(255, 255, 255, 0.3)";
          }
        });

      window.addEventListener("load", () => {
        // Link fallback: sin href, sólo handler
        /*const fallback = document.getElementById("fallbackLink");
        if (fallback) {
          fallback.removeAttribute("href");
          fallback.style.cursor = "pointer";
          fallback.addEventListener("click", openExternalAndPoll);
        }
        // Botón verde
        const btn = document.getElementById("openExternalBtn");
        if (btn) btn.addEventListener("click", openExternalAndPoll);
        
        */
        // Estado del botón pagar
        const pay = document.getElementById("payButton");
        if (pay) pay.disabled = true;
        updatePayButton();
      });

      // Prevenir envío de formulario
      document.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          const pb = document.getElementById("payButton");
          if (pb && !pb.disabled) processPayment();
        }
      });

      // Mostrar tiempo restante
      function showTimeRemaining() {
        // Simular tiempo restante de una conexión activa
        const remainingTime = localStorage.getItem("wifiTimeRemaining");
        if (remainingTime) {
          const timeLeft = parseInt(remainingTime);
          const hours = Math.floor(timeLeft / 3600);
          const minutes = Math.floor((timeLeft % 3600) / 60);
          const seconds = timeLeft % 60;

          alert(
            `⏰ Tiempo restante de tu conexión actual:\n\n${hours
              .toString()
              .padStart(2, "0")}:${minutes
              .toString()
              .padStart(2, "0")}:${seconds
              .toString()
              .padStart(2, "0")}\n\nVelocidad actual: ${
              localStorage.getItem("currentSpeed") || "25 Mbps"
            }`
          );
        } else {
          alert(
            "⏰ No tienes una conexión activa en este momento.\n\nSelecciona un plan para conectarte."
          );
        }
      }

      /*
      // Actualizar tiempo restante cada segundo
      function updateTimeRemaining() {
        const remainingTime = localStorage.getItem("wifiTimeRemaining");
        const timeDisplay = document.getElementById("timeRemaining");

        if (remainingTime && parseInt(remainingTime) > 0) {
          const timeLeft = parseInt(remainingTime);
          const hours = Math.floor(timeLeft / 3600);
          const minutes = Math.floor((timeLeft % 3600) / 60);
          const seconds = timeLeft % 60;

          timeDisplay.textContent = `${hours
            .toString()
            .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
          timeDisplay.style.color = timeLeft < 300 ? "#ff4757" : "#2ed573"; // Rojo si quedan menos de 5 minutos

          // Decrementar tiempo
          localStorage.setItem("wifiTimeRemaining", (timeLeft - 1).toString());

          if (timeLeft <= 1) {
            alert(
              "⏰ Tu tiempo de conexión ha expirado.\n\nSelecciona un nuevo plan para continuar navegando."
            );
            localStorage.removeItem("wifiTimeRemaining");
            localStorage.removeItem("currentSpeed");
            timeDisplay.textContent = "--:--:--";
            timeDisplay.style.color = "#feca57";
          }
        } else {
          timeDisplay.textContent = "--:--:--";
          timeDisplay.style.color = "#feca57";
        }
      }

      // Iniciar timer de tiempo restante al cargar la página
      setInterval(updateTimeRemaining, 1000);
      updateTimeRemaining(); // Ejecutar inmediatamente

      // CSS adicional para animación de entrada
      const style = document.createElement("style");
      style.textContent = `
                @keyframes fadeInUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
      document.head.appendChild(style);
      */
    </script>
  </body>
</html>
